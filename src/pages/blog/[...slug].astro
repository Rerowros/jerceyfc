---
// src/pages/blog/[...slug].astro
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/layout/Header.astro';
import Footer from '../../components/layout/Footer.astro';
import Lang from '../../components/content/Lang.astro';
import Callout from '../../components/content/Callout.astro';
import References from '../../components/content/References.astro';
import { Image } from 'astro:assets';
import TelegramIcon from '../../components/icons/TelegramIcon.astro';
import EmailIcon from '../../components/icons/EmailIcon.astro';
import SparklesIcon from '../../components/icons/SparklesIcon.astro';
import '../../styles/blog-post.css';
export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content, headings } = await post.render();

const seoTitle = `${post.data.title.ru} | Blog Rerowros`;
const seoDesc = post.data.excerpt.ru;
const currentUrl = `https://rerowros.ru/blog/${post.slug}`;
const ogImageUrl = `/blog/${post.slug}/og.png`;

const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: post.data.title.ru,
  description: post.data.excerpt.ru,
  image: ogImageUrl.toString(),
  datePublished: post.data.pubDate.toISOString(),
  author: {
    '@type': 'Person',
    name: 'Rerowros',
    url: 'https://rerowros.ru',
  },
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': `https://rerowros.ru/blog/${post.slug}`,
  },
};
---

<Layout title={seoTitle} description={seoDesc} pathname={`/blog/${post.slug}`} image={ogImageUrl}>
  <script type="application/ld+json" is:inline set:html={JSON.stringify(jsonLd)} />

  <Header />

  <div
    id="progress-container"
    class="pointer-events-none fixed top-0 left-0 z-[60] h-1 w-full bg-transparent"
  >
    <div
      id="progress-bar"
      class="h-full w-0 bg-[var(--color-primary)] shadow-[0_0_15px_var(--color-primary)] transition-all duration-100 ease-out"
    >
    </div>
  </div>

  <article class="post-page min-h-screen pt-24 pb-20 md:pt-32">
    <!-- Hero Section -->
    <div class="container mx-auto mb-12 max-w-5xl px-4 text-center md:mb-16">
      <div
        class="glass-card mb-8 inline-flex items-center gap-3 rounded-full border border-[var(--color-border)] px-4 py-2 shadow-sm backdrop-blur-md"
      >
        <span class="font-mono text-xs text-[var(--color-foreground)]">
          {
            post.data.pubDate.toLocaleDateString('ru-RU', {
              day: 'numeric',
              month: 'long',
              year: 'numeric',
            })
          }
        </span>
        <span class="h-1 w-1 rounded-full bg-[var(--color-muted-foreground)]"></span>
        {
          post.data.readingTime && (
            <span class="flex items-center gap-1 text-xs text-[var(--color-muted-foreground)]">
              <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              {post.data.readingTime}
            </span>
          )
        }
      </div>

      <h1
        class="font-cinzel text-glow relative z-10 mb-8 px-2 text-3xl leading-[1.1] font-extrabold break-words md:text-5xl lg:text-7xl"
      >
        <span class="lang-ru">{post.data.title.ru}</span>
        <span class="lang-en">{post.data.title.en || post.data.title.ru}</span>
      </h1>

      <div class="mb-10 flex flex-wrap justify-center gap-2">
        {
          post.data.tags.map((tag) => (
            <a
              href={`/blog/tag/${tag}`}
              class="group relative overflow-hidden rounded-full border border-[var(--color-border)] bg-[var(--color-background)] px-4 py-1.5 transition-all hover:border-[var(--color-primary)]"
            >
              <span class="absolute inset-0 bg-[var(--color-primary)] opacity-0 transition-opacity group-hover:opacity-10" />
              <span class="relative text-xs font-bold text-[var(--color-muted-foreground)] transition-colors group-hover:text-[var(--color-primary)]">
                #{tag}
              </span>
            </a>
          ))
        }
      </div>

      {
        post.data.coverImage && (
          <div class="group relative mb-8 aspect-[21/9] w-full overflow-hidden rounded-3xl border border-[var(--color-border)] shadow-2xl">
            <Image
              src={post.data.coverImage}
              alt={post.data.title.ru}
              class="h-full w-full object-cover transition-transform duration-700 group-hover:scale-105"
              width={1600}
              height={900}
              quality={95}
              priority
            />
          </div>
        )
      }
    </div>

    <div
      class="relative container mx-auto grid max-w-7xl grid-cols-1 items-start gap-10 px-4 lg:grid-cols-[1fr_300px]"
    >
      <div class="min-w-0">
        <div
          class="prose-container rounded-3xl border border-[var(--color-border)] bg-[var(--color-background)]/40 p-4 shadow-xl backdrop-blur-sm md:p-10 lg:p-12"
        >
          <!-- TL;DR BLOCK -->
          {
            post.data.tldr && (
              <details class="accordion-item group mb-12 overflow-hidden rounded-2xl border border-[var(--color-primary)]/20 bg-[var(--color-primary)]/5 transition-colors open:bg-[var(--color-primary)]/10">
                <summary class="flex cursor-pointer list-none items-center justify-between p-6 select-none md:p-8">
                  <div class="flex items-center gap-2 text-[var(--color-primary)]">
                    <SparklesIcon class="h-5 w-5" />
                    <span class="font-cinzel text-sm font-bold tracking-widest uppercase">
                      <span class="lang-ru">Коротко о главном (TL;DR)</span>
                      <span class="lang-en">Quick Summary (TL;DR)</span>
                    </span>
                  </div>
                  <svg
                    class="h-5 w-5 text-[var(--color-primary)] transition-transform duration-300 group-open:rotate-180"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 9l-7 7-7-7"
                    />
                  </svg>
                </summary>

                <div class="accordion-content">
                  <div class="px-6 pb-6 md:px-8 md:pb-8">
                    <div class="border-l-2 border-[var(--color-primary)] pl-4 text-base leading-relaxed text-[var(--color-foreground)] italic opacity-90 md:text-lg">
                      <span class="lang-ru">{post.data.tldr.ru}</span>
                      <span class="lang-en">{post.data.tldr.en || post.data.tldr.ru}</span>
                    </div>
                  </div>
                </div>
              </details>
            )
          }

          <div
            class="article-content prose prose-lg dark:prose-invert prose-headings:font-cinzel prose-headings:scroll-mt-32 prose-a:text-[var(--color-primary)] prose-a:no-underline hover:prose-a:underline max-w-none overflow-hidden"
          >
            <Content components={{ Lang, Callout, References }} />
          </div>

          <!-- CONTACT CTA AT THE END -->
          <div
            class="mt-16 rounded-3xl border border-[var(--color-primary)]/20 bg-gradient-to-br from-[var(--color-primary)]/10 via-transparent to-transparent p-8 md:p-12"
          >
            <div class="max-w-2xl">
              <h3 class="font-cinzel mb-4 text-2xl font-bold md:text-3xl">
                <span class="lang-ru">Понравился материал?</span>
                <span class="lang-en">Liked the article?</span>
              </h3>
              <p class="mb-8 text-[var(--color-muted-foreground)] md:text-lg">
                <span class="lang-ru"
                  >Если у вас есть вопросы по теме или вы хотите обсудить сотрудничество — пишите
                  мне. Я всегда на связи в Telegram.</span
                >
                <span class="lang-en"
                  >If you have questions or want to discuss a potential project, feel free to reach
                  out. I'm usually active on Telegram.</span
                >
              </p>
              <div class="flex flex-wrap gap-4">
                <a
                  href="https://t.me/Rerowros"
                  target="_blank"
                  class="btn-primary flex items-center gap-3 px-8 py-4"
                >
                  <TelegramIcon class="h-5 w-5" />
                  <span class="lang-ru">Написать в Telegram</span>
                  <span class="lang-en">Message via Telegram</span>
                </a>
                <a
                  href="mailto:rerowros@gmail.com"
                  class="group flex items-center justify-center gap-3 rounded-xl border border-[var(--color-border)] bg-[var(--color-card)] px-8 py-4 font-semibold text-[var(--color-foreground)] transition-all hover:border-[var(--color-primary)] hover:text-[var(--color-primary)]"
                >
                  <EmailIcon class="h-5 w-5" />
                  <span>Email</span>
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>

      <aside class="sticky top-24 hidden h-[calc(100vh-6rem)] lg:block">
        <div class="flex h-full flex-col gap-4">
          <div
            class="glass-card flex min-h-0 flex-1 flex-col overflow-hidden rounded-2xl border border-[var(--color-border)] shadow-lg"
            id="toc-container"
          >
            <div
              class="shrink-0 border-b border-[var(--color-border)] bg-[var(--color-card)]/50 p-4 backdrop-blur"
            >
              <h4
                class="font-cinzel flex items-center gap-2 text-xs font-bold tracking-widest text-[var(--color-muted-foreground)] uppercase"
              >
                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 6h16M4 12h16M4 18h7"></path>
                </svg>
                <span class="lang-ru">Навигация</span>
                <span class="lang-en">Contents</span>
              </h4>
            </div>

            <nav class="custom-scrollbar flex-1 overflow-y-auto p-4" id="toc-nav">
              <ul class="flex flex-col gap-1">
                {
                  headings.map((heading) => (
                    <li>
                      <a
                        href={`#${heading.slug}`}
                        class={`toc-link block rounded-lg border-l-2 border-transparent px-3 py-1.5 text-sm transition-all duration-200 ${
                          heading.depth === 1 ? 'mt-2 font-bold' : ''
                        } ${heading.depth === 3 ? 'pl-6 text-xs' : 'pl-3'} text-[var(--color-muted-foreground)] hover:border-[var(--color-primary)]/30 hover:bg-[var(--color-primary)]/5 hover:text-[var(--color-foreground)]`}
                        data-id={heading.slug}
                      >
                        {heading.text}
                      </a>
                    </li>
                  ))
                }
              </ul>
            </nav>
          </div>

          <!-- 2. Кнопка "Есть проект?" (Фиксированный размер, shrink-0 запрещает сжатие) -->
          <div
            class="glass-card group relative shrink-0 overflow-hidden rounded-2xl border border-[var(--color-primary)]/30 p-5 shadow-lg transition-all hover:border-[var(--color-primary)]"
          >
            <div
              class="absolute -top-6 -right-6 h-20 w-20 rounded-full bg-[var(--color-primary)]/10 blur-2xl transition-colors group-hover:bg-[var(--color-primary)]/20"
            >
            </div>
            <p
              class="relative z-10 mb-4 text-[11px] font-bold tracking-widest text-[var(--color-muted-foreground)] uppercase"
            >
              <span class="lang-ru">Есть проект?</span>
              <span class="lang-en">Have a project?</span>
            </p>
            <a
              href="https://t.me/Rerowros"
              target="_blank"
              class="relative z-10 flex w-full items-center justify-center gap-2 rounded-xl bg-[var(--color-primary)] py-3 text-sm font-bold text-white shadow-lg transition-transform active:scale-95"
            >
              <TelegramIcon class="h-4 w-4" />
              <span class="lang-ru">Обсудить</span>
              <span class="lang-en">Let's talk</span>
            </a>
          </div>

          <!-- 3. Кнопка Share (Фиксированный размер, shrink-0) -->
          <div
            class="glass-card shrink-0 rounded-2xl border border-[var(--color-border)] p-4 shadow-lg"
          >
            <h4
              class="mb-3 text-[10px] font-bold tracking-widest text-[var(--color-muted-foreground)] uppercase"
            >
              Share
            </h4>
            <div class="grid grid-cols-2 gap-2">
              <a
                href={`https://t.me/share/url?url=${currentUrl}&text=${post.data.title.ru}`}
                target="_blank"
                class="group flex items-center justify-center gap-2 rounded-lg border border-[var(--color-border)] bg-[var(--color-background)] p-2 transition-all hover:border-[#0088cc] hover:text-[#0088cc]"
              >
                <TelegramIcon class="h-5 w-5 transition-transform group-hover:scale-110" />
              </a>
              <button
                class="copy-link-btn group flex items-center justify-center gap-2 rounded-lg border border-[var(--color-border)] bg-[var(--color-background)] p-2 transition-all hover:border-[var(--color-primary)] hover:text-[var(--color-primary)]"
                data-url={currentUrl}
              >
                <svg
                  class="h-5 w-5 transition-transform group-hover:scale-110"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"
                  ></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </article>

  <Footer />
</Layout>

<script>
  function initBlogPost() {
    // 1. Progress Bar
    const progressBar = document.getElementById('progress-bar');
    const updateProgress = () => {
      if (!progressBar) return;
      const scrollTop = window.scrollY;
      const docHeight = document.body.scrollHeight - window.innerHeight;
      progressBar.style.width = `${(scrollTop / docHeight) * 100}%`;
    };
    window.addEventListener('scroll', updateProgress, { passive: true });

    // 2. TOC: Умный скролл и подсветка
    const tocLinks = document.querySelectorAll('.toc-link');
    const tocNav = document.getElementById('toc-nav');
    const tocContainer = document.getElementById('toc-container');

    // Флаг: пользователь навел мышь на меню?
    let isHoveringToc = false;

    if (tocContainer) {
      tocContainer.addEventListener('mouseenter', () => {
        isHoveringToc = true;
      });
      tocContainer.addEventListener('mouseleave', () => {
        isHoveringToc = false;
      });
    }

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            // Снимаем активный класс со всех
            tocLinks.forEach((l) => l.classList.remove('active'));

            // Находим ссылку для текущего заголовка
            const activeLink = document.querySelector(`.toc-link[data-id="${entry.target.id}"]`);

            if (activeLink) {
              activeLink.classList.add('active');

              // АВТО-СКРОЛЛ:
              // Работает только если пользователь НЕ держит мышку над меню.
              // Это решает проблему "откатывания" при ручном скролле меню.
              if (tocNav && !isHoveringToc) {
                activeLink.scrollIntoView({
                  behavior: 'smooth',
                  block: 'nearest', // ВАЖНО: скроллит только если элемент выходит за границы видимости
                  inline: 'nearest',
                });
              }
            }
          }
        });
      },
      {
        // Срабатывает, когда заголовок находится в верхней части экрана (от 10% до 80% высоты)
        rootMargin: '-10% 0px -80% 0px',
      }
    );

    document
      .querySelectorAll('.article-content h1, .article-content h2, .article-content h3')
      .forEach((h) => observer.observe(h));

    // 3. АВТО-СВОРАЧИВАНИЕ ИСТОЧНИКОВ
    const refHeading = Array.from(document.querySelectorAll('.article-content h3')).find(
      (h) => h.textContent?.includes('Источники') || h.textContent?.includes('References')
    );

    if (refHeading && refHeading.nextElementSibling) {
      const contentToWrap = refHeading.nextElementSibling;
      const details = document.createElement('details');
      details.className = 'references-container accordion-item group';
      const summary = document.createElement('summary');
      summary.innerHTML = `<span class="flex items-center gap-2"><svg class="w-5 h-5 text-[var(--color-primary)]" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>${refHeading.textContent}</span><svg class="w-4 h-4 transition-transform duration-300 group-open:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M19 9l-7 7-7-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;

      const animWrapper = document.createElement('div');
      animWrapper.className = 'accordion-content';
      const innerContent = document.createElement('div');
      innerContent.className = 'pt-0';

      animWrapper.appendChild(innerContent);
      innerContent.appendChild(contentToWrap);

      refHeading.parentNode?.insertBefore(details, refHeading);
      details.appendChild(summary);
      details.appendChild(animWrapper);
      refHeading.remove();
    }

    // 4. Copy Code & Links
    document.querySelectorAll('.copy-link-btn').forEach((btn) => {
      btn.addEventListener('click', async function (this: any) {
        await navigator.clipboard.writeText(this.dataset.url);
        const original = this.innerHTML;
        this.innerHTML =
          '<svg class="w-5 h-5 text-emerald-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>';
        setTimeout(() => (this.innerHTML = original), 2000);
      });
    });
  }

  document.addEventListener('astro:page-load', initBlogPost);
  document.addEventListener('DOMContentLoaded', initBlogPost);
</script>
