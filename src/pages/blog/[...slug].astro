---
// src/pages/blog/[...slug].astro
import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/layout/Header.astro";
import Footer from "../../components/layout/Footer.astro";
import Lang from "../../components/content/Lang.astro";
import Callout from "../../components/content/Callout.astro";
import References from "../../components/content/References.astro"; // Импортируем новый компонент
import { Image } from "astro:assets";
import TelegramIcon from "../../components/icons/TelegramIcon.astro";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content, headings } = await post.render();

const seoTitle = `${post.data.title.ru} | Blog Jersey`;
const seoDesc = post.data.excerpt.ru;
const currentUrl = `https://rerowros.ru/blog/${post.slug}`;
---

<Layout title={seoTitle} description={seoDesc} pathname={`/blog/${post.slug}`}>
  <Header />

  <!-- Scroll Progress Bar -->
  <div
    id="progress-container"
    class="fixed top-0 left-0 w-full h-1 z-[60] bg-transparent pointer-events-none"
  >
    <div
      id="progress-bar"
      class="h-full bg-[var(--color-primary)] w-0 transition-all duration-100 ease-out shadow-[0_0_15px_var(--color-primary)]"
    >
    </div>
  </div>

  <article class="post-page pt-24 md:pt-32 pb-20 min-h-screen">
    <!-- Hero Section -->
    <div class="container px-4 mx-auto max-w-5xl text-center mb-12 md:mb-16">
      <!-- Meta Data Badge -->
      <div
        class="inline-flex items-center gap-3 mb-8 px-4 py-2 rounded-full glass-card border border-[var(--color-border)] shadow-sm backdrop-blur-md"
      >
        <span class="text-xs font-mono text-[var(--color-foreground)]">
          {
            post.data.pubDate.toLocaleDateString("ru-RU", {
              day: "numeric",
              month: "long",
              year: "numeric",
            })
          }
        </span>
        <span class="w-1 h-1 rounded-full bg-[var(--color-muted-foreground)]"
        ></span>
        {
          post.data.readingTime && (
            <span class="text-xs text-[var(--color-muted-foreground)] flex items-center gap-1">
              <svg
                class="w-3 h-3"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              {post.data.readingTime}
            </span>
          )
        }
      </div>

      <!-- Title with Glow Effect -->
      <h1
        class="text-3xl md:text-5xl lg:text-7xl font-extrabold font-cinzel leading-[1.1] mb-8 text-glow relative z-10"
      >
        <span class="lang-ru">{post.data.title.ru}</span>
        <span class="lang-en">{post.data.title.en || post.data.title.ru}</span>
      </h1>

      <!-- Tags -->
      <div class="flex flex-wrap justify-center gap-2 mb-10">
        {
          post.data.tags.map((tag) => (
            <a
              href={`/blog/tag/${tag}`}
              class="group relative px-4 py-1.5 rounded-full bg-[var(--color-background)] border border-[var(--color-border)] hover:border-[var(--color-primary)] transition-all overflow-hidden"
            >
              <span class="absolute inset-0 bg-[var(--color-primary)] opacity-0 group-hover:opacity-10 transition-opacity" />
              <span class="relative text-xs font-bold text-[var(--color-muted-foreground)] group-hover:text-[var(--color-primary)] transition-colors">
                #{tag}
              </span>
            </a>
          ))
        }
      </div>

      <!-- Cover Image with Parallax-like feel -->
      {
        post.data.coverImage && (
          <div class="relative w-full aspect-[21/9] rounded-3xl overflow-hidden border border-[var(--color-border)] shadow-2xl mb-8 group">
            <div class="absolute inset-0 bg-gradient-to-t from-[var(--color-background)] to-transparent opacity-20 z-10" />
            <Image
              src={post.data.coverImage}
              alt={post.data.title.ru}
              class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
              width={1600}
              height={900}
              quality={95}
              priority
            />
          </div>
        )
      }
    </div>

    <!-- Main Content Layout -->
    <div
      class="container px-4 mx-auto grid grid-cols-1 lg:grid-cols-[1fr_300px] gap-10 max-w-7xl relative"
    >
      <!-- Article Column -->
      <div class="min-w-0">
        <!-- min-w-0 prevents grid overflow -->
        <div
          class="prose-container bg-[var(--color-background)]/40 backdrop-blur-sm border border-[var(--color-border)] rounded-3xl p-6 md:p-10 lg:p-12 shadow-xl"
        >
          <div
            class="article-content prose prose-lg dark:prose-invert max-w-none
              prose-headings:font-cinzel prose-headings:scroll-mt-32
              prose-a:text-[var(--color-primary)] prose-a:no-underline hover:prose-a:underline hover:prose-a:text-[var(--color-primary-hover)]
              prose-img:rounded-xl prose-img:shadow-lg prose-img:border prose-img:border-[var(--color-border)]"
          >
            <Content components={{ Lang, Callout, References }} />
          </div>
        </div>

        <!-- Mobile Bottom Actions -->
        <div
          class="mt-10 lg:hidden flex flex-col gap-6 p-6 rounded-2xl border border-[var(--color-border)] bg-[var(--color-card)]"
        >
          <h4 class="text-center font-cinzel font-bold">
            Поделиться материалом
          </h4>
          <div class="flex justify-center gap-3">
            <a
              href={`https://t.me/share/url?url=${currentUrl}&text=${post.data.title.ru}`}
              target="_blank"
              class="btn-share w-full bg-[var(--color-card)] border border-[var(--color-border)] text-[var(--color-foreground)] hover:bg-[var(--color-primary)] hover:text-white hover:border-[var(--color-primary)]"
            >
              <TelegramIcon class="w-5 h-5" /> Telegram
            </a>
            <button
              class="btn-share copy-link-btn w-full bg-[var(--color-card)] border border-[var(--color-border)] text-[var(--color-foreground)] hover:bg-[var(--color-primary)] hover:text-white hover:border-[var(--color-primary)]"
              data-url={currentUrl}
            >
              <svg
                class="w-5 h-5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                ><path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
                ></path></svg
              >
              Link
            </button>
          </div>
        </div>
      </div>

      <!-- Sidebar (now non-sticky: will scroll with the page) -->
      <aside class="hidden lg:block sticky top-32 h-fit">
        <div class="space-y-6 flex flex-col">
          <!-- Table of Contents -->
          <div
            class="glass-card rounded-2xl border border-[var(--color-border)] overflow-hidden flex flex-col shadow-lg ring-1 ring-white/5"
          >
            <div
              class="p-4 border-b border-[var(--color-border)] bg-[var(--color-card)]/50 backdrop-blur"
            >
              <h4
                class="font-cinzel font-bold text-xs uppercase tracking-widest text-[var(--color-muted-foreground)] flex items-center gap-2"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 6h16M4 12h16M4 18h7"></path></svg
                >
                <span class="lang-ru">Навигация</span>
                <span class="lang-en">Contents</span>
              </h4>
            </div>

            <nav class="p-4 custom-scrollbar" id="toc-nav">
              <ul class="flex flex-col gap-1">
                {
                  headings.map((heading) => (
                    <li>
                      <a
                        href={`#${heading.slug}`}
                        class={`toc-link block text-sm py-1.5 px-3 rounded-lg transition-all duration-200 border-l-2 border-transparent
                        ${heading.depth === 1 ? "font-bold mt-2" : ""}
                        ${heading.depth === 2 ? "pl-3" : ""}
                        ${heading.depth === 3 ? "pl-6 text-xs" : ""}
                        text-[var(--color-muted-foreground)] hover:text-[var(--color-foreground)] hover:bg-[var(--color-primary)]/5 hover:border-[var(--color-primary)]/30`}
                        data-id={heading.slug}
                      >
                        {heading.text}
                      </a>
                    </li>
                  ))
                }
              </ul>
            </nav>
          </div>

          <!-- Actions -->
          <div
            class="glass-card p-4 rounded-2xl border border-[var(--color-border)] shadow-lg"
          >
            <h4
              class="font-bold text-[10px] uppercase tracking-widest text-[var(--color-muted-foreground)] mb-3"
            >
              Share
            </h4>
            <div class="grid grid-cols-2 gap-2">
              <a
                href={`https://t.me/share/url?url=${currentUrl}&text=${post.data.title.ru}`}
                target="_blank"
                class="flex items-center justify-center gap-2 p-2 rounded-lg bg-[var(--color-background)] border border-[var(--color-border)] hover:border-[#0088cc] hover:text-[#0088cc] transition-all group"
              >
                <TelegramIcon
                  class="w-5 h-5 group-hover:scale-110 transition-transform"
                />
              </a>
              <button
                class="copy-link-btn flex items-center justify-center gap-2 p-2 rounded-lg bg-[var(--color-background)] border border-[var(--color-border)] hover:border-[var(--color-primary)] hover:text-[var(--color-primary)] transition-all group"
                data-url={currentUrl}
              >
                <svg
                  class="w-5 h-5 group-hover:scale-110 transition-transform"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"
                  ></path></svg
                >
              </button>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </article>

  <Footer />
</Layout>

<script>
  function initBlogPost() {
    // 1. Progress Bar Logic
    const progressBar = document.getElementById("progress-bar");
    const updateProgress = () => {
      if (!progressBar) return;
      const scrollTop = window.scrollY;
      const docHeight = document.body.scrollHeight - window.innerHeight;
      const scrollPercent = scrollTop / docHeight;
      progressBar.style.width = `${scrollPercent * 100}%`;
    };
    window.addEventListener("scroll", updateProgress, { passive: true });

    // 2. Advanced TOC Logic (Active State & Language Filtering)
    const tocLinks = document.querySelectorAll(".toc-link");
    const sections = new Map();

    // Language Filtering
    tocLinks.forEach((link) => {
      // @ts-ignore
      const id = link.dataset.id;
      const headingEl = document.getElementById(id);
      if (headingEl) {
        sections.set(id, headingEl);
        // Auto-hide incorrect languages in TOC
        if (headingEl.closest(".lang-ru")) link.classList.add("lang-ru");
        else if (headingEl.closest(".lang-en")) link.classList.add("lang-en");
      }
    });

    // Intersection Observer for ScrollSpy
    const observerOptions = {
      root: null,
      rootMargin: "-100px 0px -70% 0px", // Trigger when heading is near top
      threshold: 0,
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const id = entry.target.id;

          // Remove active class from all
          tocLinks.forEach((l) => l.classList.remove("active"));

          // Add active class to current and parents
          const activeLink = document.querySelector(
            `.toc-link[data-id="${id}"]`
          );
          if (activeLink) {
            activeLink.classList.add("active");

            // Scroll TOC container instead of the whole page when possible
            const tocNav = document.getElementById("toc-nav");
            if (
              tocNav &&
              tocNav.contains(activeLink) &&
              tocNav.scrollHeight > tocNav.clientHeight
            ) {
              // center the active link in the toc viewport
              const activeEl = activeLink as HTMLElement;
              const tocEl = tocNav as HTMLElement;
              tocEl.scrollTo({
                top: Math.max(0, activeEl.offsetTop - tocEl.clientHeight / 2),
                behavior: "smooth",
              });
            } else {
              // No page scroll: ensure the active link can be focused without scrolling
              try {
                const activeEl = activeLink as HTMLElement;
                if (typeof activeEl.focus === "function") {
                  activeEl.focus({ preventScroll: true });
                }
              } catch (e) {
                // ignore - preventScroll may not be supported in older browsers
              }
            }
          }
        }
      });
    }, observerOptions);

    sections.forEach((el) => observer.observe(el));

    // 3. Code Block Copy Buttons (Enhanced)
    document.querySelectorAll(".article-content pre").forEach((pre) => {
      if (pre.closest(".code-wrapper")) return;

      const wrapper = document.createElement("div");
      wrapper.className =
        "code-wrapper group relative my-6 rounded-xl overflow-hidden border border-[var(--color-border)] bg-[#0d1117] shadow-xl";

      // Extract language
      let lang = "";
      pre.classList.forEach((c) => {
        if (c.startsWith("language-")) lang = c.replace("language-", "");
      });

      // Header
      const header = document.createElement("div");
      header.className =
        "flex items-center justify-between px-4 py-2 bg-[#161b22] border-b border-[#30363d]";
      header.innerHTML = `
        <span class="text-xs font-mono text-[#7d8590] uppercase tracking-wider">${lang || "Code"}</span>
        <button class="copy-btn text-[#7d8590] hover:text-white transition-colors p-1 rounded hover:bg-[#30363d]" aria-label="Copy">
             <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
        </button>
      `;

      pre.parentNode?.insertBefore(wrapper, pre);
      wrapper.appendChild(header);
      wrapper.appendChild(pre);

      // Copy Logic
      header
        .querySelector(".copy-btn")
        ?.addEventListener("click", async function (this: HTMLButtonElement) {
          await navigator.clipboard.writeText(pre.textContent || "");
          const icon = this.innerHTML;
          this.innerHTML = `<svg class="w-4 h-4 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>`;
          setTimeout(() => {
            this.innerHTML = icon;
          }, 2000);
        });
    });
  }

  document.addEventListener("astro:page-load", initBlogPost);
</script>
