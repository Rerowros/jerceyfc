---
// src/pages/blog/[...slug].astro

import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/layout/Header.astro';
import Footer from '../../components/layout/Footer.astro';
import Lang from '../../components/content/Lang.astro';
import Callout from '../../components/content/Callout.astro';
import References from '../../components/content/References.astro'; // Импортируем новый компонент
import { Image } from 'astro:assets';
import TelegramIcon from '../../components/icons/TelegramIcon.astro';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content, headings } = await post.render();

const seoTitle = `${post.data.title.ru} | Blog Jersey`;
const seoDesc = post.data.excerpt.ru;
const currentUrl = `https://rerowros.ru/blog/${post.slug}`;

const ogImageUrl = new URL(`/blog/${post.slug}/og.png`, Astro.site);

// Формируем объект JSON-LD для Google
const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: post.data.title.ru,
  description: post.data.excerpt.ru,
  image: ogImageUrl.toString(),
  datePublished: post.data.pubDate.toISOString(),
  author: {
    '@type': 'Person',
    name: 'Jersey',
    url: 'https://rerowros.ru',
  },
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': `https://rerowros.ru/blog/${post.slug}`,
  },
};
---

<Layout
  title={`${post.data.title.ru} | Blog Jersey`}
  description={post.data.excerpt.ru}
  pathname={`/blog/${post.slug}`}
>
  <!-- Вставляем JSON-LD в секцию head (Astro передаст это в Layout через слот или можно добавить в Layout напрямую) -->
  <script type="application/ld+json" is:inline set:html={JSON.stringify(jsonLd)} />

  <!-- Обновляем мета-теги изображений (если в Layout.astro они принимаются как пропсы, 
       лучше передать их туда. Если нет — добавь прямо в head через <Layout>) -->
  <Fragment slot="head">
    <meta property="og:image" content={ogImageUrl} />
    <meta name="twitter:image" content={ogImageUrl} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
  </Fragment>
  <Header />

  <!-- Scroll Progress Bar -->
  <div
    id="progress-container"
    class="pointer-events-none fixed top-0 left-0 z-[60] h-1 w-full bg-transparent"
  >
    <div
      id="progress-bar"
      class="h-full w-0 bg-[var(--color-primary)] shadow-[0_0_15px_var(--color-primary)] transition-all duration-100 ease-out"
    >
    </div>
  </div>

  <article class="post-page min-h-screen pt-24 pb-20 md:pt-32">
    <!-- Hero Section -->
    <div class="container mx-auto mb-12 max-w-5xl px-4 text-center md:mb-16">
      <!-- Meta Data Badge -->
      <div
        class="glass-card mb-8 inline-flex items-center gap-3 rounded-full border border-[var(--color-border)] px-4 py-2 shadow-sm backdrop-blur-md"
      >
        <span class="font-mono text-xs text-[var(--color-foreground)]">
          {
            post.data.pubDate.toLocaleDateString('ru-RU', {
              day: 'numeric',
              month: 'long',
              year: 'numeric',
            })
          }
        </span>
        <span class="h-1 w-1 rounded-full bg-[var(--color-muted-foreground)]"></span>
        {
          post.data.readingTime && (
            <span class="flex items-center gap-1 text-xs text-[var(--color-muted-foreground)]">
              <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              {post.data.readingTime}
            </span>
          )
        }
      </div>

      <!-- Title with Glow Effect -->
      <h1
        class="font-cinzel text-glow relative z-10 mb-8 text-3xl leading-[1.1] font-extrabold md:text-5xl lg:text-7xl"
      >
        <span class="lang-ru">{post.data.title.ru}</span>
        <span class="lang-en">{post.data.title.en || post.data.title.ru}</span>
      </h1>

      <!-- Tags -->
      <div class="mb-10 flex flex-wrap justify-center gap-2">
        {
          post.data.tags.map((tag) => (
            <a
              href={`/blog/tag/${tag}`}
              class="group relative overflow-hidden rounded-full border border-[var(--color-border)] bg-[var(--color-background)] px-4 py-1.5 transition-all hover:border-[var(--color-primary)]"
            >
              <span class="absolute inset-0 bg-[var(--color-primary)] opacity-0 transition-opacity group-hover:opacity-10" />
              <span class="relative text-xs font-bold text-[var(--color-muted-foreground)] transition-colors group-hover:text-[var(--color-primary)]">
                #{tag}
              </span>
            </a>
          ))
        }
      </div>

      <!-- Cover Image with Parallax-like feel -->
      {
        post.data.coverImage && (
          <div class="group relative mb-8 aspect-[21/9] w-full overflow-hidden rounded-3xl border border-[var(--color-border)] shadow-2xl">
            <div class="absolute inset-0 z-10 bg-gradient-to-t from-[var(--color-background)] to-transparent opacity-20" />
            <Image
              src={post.data.coverImage}
              alt={post.data.title.ru}
              class="h-full w-full object-cover transition-transform duration-700 group-hover:scale-105"
              width={1600}
              height={900}
              quality={95}
              priority
            />
          </div>
        )
      }
    </div>

    <!-- Main Content Layout -->
    <div
      class="relative container mx-auto grid max-w-7xl grid-cols-1 gap-10 px-4 lg:grid-cols-[1fr_300px]"
    >
      <!-- Article Column -->
      <div class="min-w-0">
        <!-- min-w-0 prevents grid overflow -->
        <div
          class="prose-container rounded-3xl border border-[var(--color-border)] bg-[var(--color-background)]/40 p-6 shadow-xl backdrop-blur-sm md:p-10 lg:p-12"
        >
          <div
            class="article-content prose prose-lg dark:prose-invert prose-headings:font-cinzel prose-headings:scroll-mt-32 prose-a:text-[var(--color-primary)] prose-a:no-underline hover:prose-a:underline hover:prose-a:text-[var(--color-primary-hover)] prose-img:rounded-xl prose-img:shadow-lg prose-img:border prose-img:border-[var(--color-border)] max-w-none"
          >
            <Content components={{ Lang, Callout, References }} />
          </div>
        </div>

        <!-- Mobile Bottom Actions -->
        <div
          class="mt-10 flex flex-col gap-6 rounded-2xl border border-[var(--color-border)] bg-[var(--color-card)] p-6 lg:hidden"
        >
          <h4 class="font-cinzel text-center font-bold">Поделиться материалом</h4>
          <div class="flex justify-center gap-3">
            <a
              href={`https://t.me/share/url?url=${currentUrl}&text=${post.data.title.ru}`}
              target="_blank"
              class="btn-share w-full border border-[var(--color-border)] bg-[var(--color-card)] text-[var(--color-foreground)] hover:border-[var(--color-primary)] hover:bg-[var(--color-primary)] hover:text-white"
            >
              <TelegramIcon class="h-5 w-5" /> Telegram
            </a>
            <button
              class="btn-share copy-link-btn w-full border border-[var(--color-border)] bg-[var(--color-card)] text-[var(--color-foreground)] hover:border-[var(--color-primary)] hover:bg-[var(--color-primary)] hover:text-white"
              data-url={currentUrl}
            >
              <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                ><path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
                ></path></svg
              >
              Link
            </button>
          </div>
        </div>
      </div>

      <!-- Sidebar (now non-sticky: will scroll with the page) -->
      <aside class="sticky top-32 hidden h-fit lg:block">
        <div class="flex flex-col space-y-6">
          <!-- Table of Contents -->
          <div
            class="glass-card flex flex-col overflow-hidden rounded-2xl border border-[var(--color-border)] shadow-lg ring-1 ring-white/5"
          >
            <div
              class="border-b border-[var(--color-border)] bg-[var(--color-card)]/50 p-4 backdrop-blur"
            >
              <h4
                class="font-cinzel flex items-center gap-2 text-xs font-bold tracking-widest text-[var(--color-muted-foreground)] uppercase"
              >
                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                  ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 6h16M4 12h16M4 18h7"></path></svg
                >
                <span class="lang-ru">Навигация</span>
                <span class="lang-en">Contents</span>
              </h4>
            </div>

            <nav class="custom-scrollbar p-4" id="toc-nav">
              <ul class="flex flex-col gap-1">
                {
                  headings.map((heading) => (
                    <li>
                      <a
                        href={`#${heading.slug}`}
                        class={`toc-link block rounded-lg border-l-2 border-transparent px-3 py-1.5 text-sm transition-all duration-200 ${heading.depth === 1 ? 'mt-2 font-bold' : ''} ${heading.depth === 2 ? 'pl-3' : ''} ${heading.depth === 3 ? 'pl-6 text-xs' : ''} text-[var(--color-muted-foreground)] hover:border-[var(--color-primary)]/30 hover:bg-[var(--color-primary)]/5 hover:text-[var(--color-foreground)]`}
                        data-id={heading.slug}
                      >
                        {heading.text}
                      </a>
                    </li>
                  ))
                }
              </ul>
            </nav>
          </div>

          <!-- Actions -->
          <div class="glass-card rounded-2xl border border-[var(--color-border)] p-4 shadow-lg">
            <h4
              class="mb-3 text-[10px] font-bold tracking-widest text-[var(--color-muted-foreground)] uppercase"
            >
              Share
            </h4>
            <div class="grid grid-cols-2 gap-2">
              <a
                href={`https://t.me/share/url?url=${currentUrl}&text=${post.data.title.ru}`}
                target="_blank"
                class="group flex items-center justify-center gap-2 rounded-lg border border-[var(--color-border)] bg-[var(--color-background)] p-2 transition-all hover:border-[#0088cc] hover:text-[#0088cc]"
              >
                <TelegramIcon class="h-5 w-5 transition-transform group-hover:scale-110" />
              </a>
              <button
                class="copy-link-btn group flex items-center justify-center gap-2 rounded-lg border border-[var(--color-border)] bg-[var(--color-background)] p-2 transition-all hover:border-[var(--color-primary)] hover:text-[var(--color-primary)]"
                data-url={currentUrl}
              >
                <svg
                  class="h-5 w-5 transition-transform group-hover:scale-110"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"
                  ></path></svg
                >
              </button>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </article>

  <Footer />
</Layout>

<script>
  function initBlogPost() {
    // 1. Progress Bar Logic
    const progressBar = document.getElementById('progress-bar');
    const updateProgress = () => {
      if (!progressBar) return;
      const scrollTop = window.scrollY;
      const docHeight = document.body.scrollHeight - window.innerHeight;
      const scrollPercent = scrollTop / docHeight;
      progressBar.style.width = `${scrollPercent * 100}%`;
    };
    window.addEventListener('scroll', updateProgress, { passive: true });

    // 2. Advanced TOC Logic (Active State & Language Filtering)
    const tocLinks = document.querySelectorAll('.toc-link');
    const sections = new Map();

    // Language Filtering
    tocLinks.forEach((link) => {
      // @ts-ignore
      const id = link.dataset.id;
      const headingEl = document.getElementById(id);
      if (headingEl) {
        sections.set(id, headingEl);
        // Auto-hide incorrect languages in TOC
        if (headingEl.closest('.lang-ru')) link.classList.add('lang-ru');
        else if (headingEl.closest('.lang-en')) link.classList.add('lang-en');
      }
    });

    // Intersection Observer for ScrollSpy
    const observerOptions = {
      root: null,
      rootMargin: '-100px 0px -70% 0px', // Trigger when heading is near top
      threshold: 0,
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const id = entry.target.id;

          // Remove active class from all
          tocLinks.forEach((l) => l.classList.remove('active'));

          // Add active class to current and parents
          const activeLink = document.querySelector(`.toc-link[data-id="${id}"]`);
          if (activeLink) {
            activeLink.classList.add('active');

            // Scroll TOC container instead of the whole page when possible
            const tocNav = document.getElementById('toc-nav');
            if (
              tocNav &&
              tocNav.contains(activeLink) &&
              tocNav.scrollHeight > tocNav.clientHeight
            ) {
              // center the active link in the toc viewport
              const activeEl = activeLink as HTMLElement;
              const tocEl = tocNav as HTMLElement;
              tocEl.scrollTo({
                top: Math.max(0, activeEl.offsetTop - tocEl.clientHeight / 2),
                behavior: 'smooth',
              });
            } else {
              // No page scroll: ensure the active link can be focused without scrolling
              try {
                const activeEl = activeLink as HTMLElement;
                if (typeof activeEl.focus === 'function') {
                  activeEl.focus({ preventScroll: true });
                }
              } catch (e) {
                // ignore - preventScroll may not be supported in older browsers
              }
            }
          }
        }
      });
    }, observerOptions);

    sections.forEach((el) => observer.observe(el));

    // 3. Code Block Copy Buttons (Enhanced)
    document.querySelectorAll('.article-content pre').forEach((pre) => {
      if (pre.closest('.code-wrapper')) return;

      const wrapper = document.createElement('div');
      wrapper.className =
        'code-wrapper group relative my-6 rounded-xl overflow-hidden border border-[var(--color-border)] bg-[#0d1117] shadow-xl';

      // Extract language
      let lang = '';
      pre.classList.forEach((c) => {
        if (c.startsWith('language-')) lang = c.replace('language-', '');
      });

      // Header
      const header = document.createElement('div');
      header.className =
        'flex items-center justify-between px-4 py-2 bg-[#161b22] border-b border-[#30363d]';
      header.innerHTML = `
        <span class="text-xs font-mono text-[#7d8590] uppercase tracking-wider">${lang || 'Code'}</span>
        <button class="copy-btn text-[#7d8590] hover:text-white transition-colors p-1 rounded hover:bg-[#30363d]" aria-label="Copy">
             <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
        </button>
      `;

      pre.parentNode?.insertBefore(wrapper, pre);
      wrapper.appendChild(header);
      wrapper.appendChild(pre);

      // Copy Logic
      header
        .querySelector('.copy-btn')
        ?.addEventListener('click', async function (this: HTMLButtonElement) {
          await navigator.clipboard.writeText(pre.textContent || '');
          const icon = this.innerHTML;
          this.innerHTML = `<svg class="w-4 h-4 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>`;
          setTimeout(() => {
            this.innerHTML = icon;
          }, 2000);
        });
    });
  }

  document.addEventListener('astro:page-load', initBlogPost);
</script>
