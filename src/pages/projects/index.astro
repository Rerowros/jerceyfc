---
// src/pages/projects/index.astro
import { getCollection } from 'astro:content';
import { fade } from 'astro:transitions';
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/layout/Header.astro';
import ProjectCard from '../../components/ui/ProjectCard.astro';
import Footer from '../../components/layout/Footer.astro';

const allProjects = await getCollection('projects');

// Сортировка: сначала featured, потом по дате
const sortedProjects = allProjects.sort((a, b) => {
  if (a.data.featured && !b.data.featured) return -1;
  if (!a.data.featured && b.data.featured) return 1;
  return b.data.pubDate.valueOf() - a.data.pubDate.valueOf();
});
---

<Layout
  title="Проекты"
  description="Кейсы и проекты: Telegram Stars, LiteForce, и другие."
  pathname="/projects"
>
  <Header />
  <main
    class="container min-h-screen pt-24 pb-16 md:pt-32"
    transition:animate={fade({ duration: '0.2s' })}
  >
    <!-- Заголовок -->
    <div class="relative mb-20 text-center">
      <div
        class="absolute top-1/2 left-1/2 -z-10 h-32 w-[120%] -translate-x-1/2 -translate-y-1/2 rounded-full bg-[var(--color-primary)]/20 blur-[100px]"
      >
      </div>

      <h1 class="font-cinzel mb-6 text-5xl font-extrabold tracking-tight md:text-7xl">
        <span
          class="lang-ru bg-300% animate-gradient bg-gradient-to-r from-white via-[var(--color-primary)] to-white bg-clip-text text-transparent"
          >Архив Работ</span
        >
        <span
          class="lang-en bg-300% animate-gradient bg-gradient-to-r from-white via-[var(--color-primary)] to-white bg-clip-text text-transparent"
          >Works Archive</span
        >
      </h1>
      <p class="mx-auto max-w-2xl text-xl text-[var(--color-muted-foreground)]">
        <span class="lang-ru"
          >Избранные коммерческие проекты, open-source инструменты и эксперименты.</span
        >
        <span class="lang-en"
          >Selected commercial projects, open-source tools, and experiments.</span
        >
      </p>
    </div>

    <!-- Сетка -->
    <!-- Убрали явную типизацию (p: CollectionEntry...) внутри HTML шаблона, чтобы не ломать парсер -->
    <div class="render-optimization grid grid-cols-1 gap-8 gap-y-12 md:grid-cols-2 lg:grid-cols-3">
      {
        sortedProjects.map((p, index) => (
          <div class="scroll-animate" style={`transition-delay: ${index * 50}ms`}>
            <ProjectCard project={p} />
          </div>
        ))
      }
    </div>
  </main>
  <Footer />
</Layout>

<style>
  .bg-300\% {
    background-size: 300% auto;
  }
  @keyframes gradient {
    0% {
      background-position: 0% 50%;
    }
    50% {
      background-position: 100% 50%;
    }
    100% {
      background-position: 0% 50%;
    }
  }
  .animate-gradient {
    animation: gradient 6s ease infinite;
  }

  .render-optimization {
    /* Значительно ускоряет начальную отрисовку длинных списков */
    content-visibility: auto;
    contain-intrinsic-size: 1px 400px; /* Примерная высота ряда карточек, чтобы скроллбар не скакал */
  }
</style>
<script>
  // Помечаем, что мы действительно были в списке проектов
  document.addEventListener('astro:page-load', () => {
    sessionStorage.setItem('from-projects-list', 'true');
  });
</script>
