---
// src/pages/projects/[...slug].astro
import { getCollection, type CollectionEntry } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/layout/Header.astro';
import Footer from '../../components/layout/Footer.astro';
import GitHubIcon from '../../components/icons/GitHubIcon.astro';
import TelegramIcon from '../../components/icons/TelegramIcon.astro';
import Lang from '../../components/content/Lang.astro'; // Импортируем наш компонент
import { slide } from 'astro:transitions';
import { Image } from 'astro:assets';

// Point 9: Динамические маршруты через getCollection
export async function getStaticPaths() {
  const projects = await getCollection('projects');
  return projects.map((project) => ({
    params: { slug: project.slug },
    props: { project },
  }));
}

interface Props {
  project: CollectionEntry<'projects'>;
}

const { project } = Astro.props;
const { data } = project;

// Point 3: Рендеринг контента
const { Content } = await project.render();

const coverImage = data.coverImage;
const hasImage = !!coverImage;
const typeGradients: Record<string, string> = {
  web: 'bg-blue-600',
  desktop: 'bg-emerald-600',
  bot: 'bg-orange-600',
  ml: 'bg-pink-600',
  library: 'bg-slate-600',
};
// @ts-ignore
const bgAccent = typeGradients[data.type] || 'bg-indigo-600';
---

<Layout
  title={data.title.ru}
  description={data.description.ru}
  pathname={`/projects/${project.slug}`}
>
  <Header />

  <!-- 1. PROJECT HERO SECTION -->
  <section
    class="relative flex min-h-[40vh] flex-col justify-end overflow-hidden px-4 pt-24 pb-12 md:min-h-[50vh] md:pt-32 md:pb-20"
  >
    <div class="absolute inset-0 z-0">
      {
        hasImage && coverImage ? (
          <>
            <Image
              src={coverImage}
              class="h-full w-full scale-110 object-cover opacity-20 blur-3xl"
              alt=""
              width={800}
              height={600}
              format="webp"
              quality={70}
            />
            <div class="absolute inset-0 bg-gradient-to-b from-[var(--color-background)] via-transparent to-[var(--color-background)]" />
          </>
        ) : (
          <div class={`absolute inset-0 opacity-10 ${bgAccent} blur-[100px]`} />
        )
      }
      <div class="absolute inset-0 opacity-[0.03]"></div>
    </div>

    <div
      class="relative z-10 container mx-auto max-w-6xl"
      transition:animate={slide({ duration: '0.5s' })}
    >
      <a
        href="/projects"
        id="back-link"
        class="group mb-4 inline-flex cursor-pointer items-center gap-2 text-sm font-medium text-[var(--color-muted-foreground)] transition-colors hover:text-[var(--color-primary)] md:mb-8"
      >
        <div
          class="flex h-8 w-8 items-center justify-center rounded-full border border-[var(--color-border)] bg-[var(--color-card)] transition-colors group-hover:border-[var(--color-primary)]"
        >
          <svg
            class="h-4 w-4 transition-transform group-hover:-translate-x-0.5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 19l-7-7 7-7"></path>
          </svg>
        </div>
        <span class="lang-ru">Назад</span>
        <span class="lang-en">Back</span>
      </a>

      <!-- Заголовок и Мета -->
      <div class="flex flex-col justify-between gap-6 md:gap-8 lg:flex-row lg:items-end">
        <div class="max-w-3xl space-y-4">
          <div class="flex items-center gap-3">
            <span
              class={`px-3 py-1 rounded-md text-xs font-bold uppercase tracking-widest border ${
                data.status === 'completed'
                  ? 'border-green-500/30 text-green-400 bg-green-500/10'
                  : data.status === 'private'
                    ? 'border-red-500/30 text-red-400 bg-red-500/10'
                    : 'border-blue-500/30 text-blue-400 bg-blue-500/10'
              }`}
            >
              {data.status}
            </span>
            <span class="font-mono text-xs text-[var(--color-muted-foreground)]">
              {
                new Date(data.pubDate).toLocaleDateString('ru-RU', {
                  year: 'numeric',
                  month: 'long',
                })
              }
            </span>
          </div>

          <h1
            class="font-cinzel text-glow text-3xl leading-[1.1] font-extrabold break-words hyphens-auto sm:text-4xl md:text-6xl lg:text-7xl"
          >
            <span class="lang-ru">{data.title.ru}</span>
            <span class="lang-en">{data.title.en}</span>
          </h1>

          <p
            class="border-l-2 border-[var(--color-primary)] pl-4 text-lg leading-relaxed font-light text-[var(--color-muted-foreground)] md:pl-6 md:text-2xl"
          >
            <span class="lang-ru">{data.description.ru}</span>
            <span class="lang-en">{data.description.en}</span>
          </p>
        </div>

        <div class="mt-2 flex flex-wrap gap-4 lg:mt-0">
          {
            data.demoUrl && (
              <a
                href={data.demoUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="btn-primary flex w-full items-center justify-center gap-2 shadow-[var(--color-primary)]/20 shadow-xl sm:w-auto"
              >
                <span class="lang-ru">Открыть Live Demo</span>
                <span class="lang-en">Live Demo</span>
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                  />
                </svg>
              </a>
            )
          }
          {
            data.repoUrl && (
              <a
                href={data.repoUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="btn flex w-full items-center justify-center gap-2 border border-[var(--color-border)] bg-[var(--color-card)] hover:border-[var(--color-foreground)] sm:w-auto"
              >
                <GitHubIcon class="h-5 w-5" />
                <span class="lang-ru">Исходный код</span>
                <span class="lang-en">Source Code</span>
              </a>
            )
          }
        </div>
      </div>
    </div>
  </section>

  <!-- 2. MAIN CONTENT GRID -->
  <main class="container mx-auto max-w-6xl px-4 py-8 md:py-12">
    <div class="grid grid-cols-1 gap-8 md:gap-12 lg:grid-cols-[1fr_360px]">
      <!-- ЛЕВАЯ КОЛОНКА -->
      <div class="space-y-8 md:space-y-12">
        {
          hasImage && coverImage && (
            <div class="overflow-hidden rounded-2xl border border-[var(--color-border)] bg-[#050505] shadow-2xl">
              <Image
                src={coverImage}
                alt={data.title.en}
                class="h-auto w-full"
                width={1200}
                height={800}
                format="webp"
                quality={90}
              />
            </div>
          )
        }

        <div class="prose prose-lg prose-invert max-w-none">
          <div
            class="glass-card relative overflow-hidden rounded-3xl border border-[var(--color-border)] p-6 md:p-10"
          >
            <div
              class="absolute top-0 left-0 h-full w-1 bg-gradient-to-b from-[var(--color-primary)] to-transparent"
            >
            </div>

            <h3
              class="font-cinzel mb-4 text-xl font-bold text-[var(--color-foreground)] md:mb-6 md:text-2xl"
            >
              <span class="lang-ru">Задача и Решение</span>
              <span class="lang-en">The Challenge & Solution</span>
            </h3>

            <div
              class="markdown-container text-base leading-loose text-[var(--color-muted-foreground)] md:text-lg"
            >
              <!-- Point 3: Вставка компонента Content. 
                   Передаем наши кастомные компоненты внутрь MDX -->
              <Content components={{ Lang }} />
            </div>
          </div>
        </div>

        {
          data.gallery && data.gallery.length > 0 && (
            <div class="space-y-6">
              <h3 class="font-cinzel text-glow text-xl font-bold md:text-2xl">
                <span class="lang-ru">Интерфейс</span>
                <span class="lang-en">Interface Gallery</span>
              </h3>
              <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                {data.gallery.map((img) => (
                  <div class="group relative aspect-video cursor-zoom-in overflow-hidden rounded-xl border border-[var(--color-border)] bg-[var(--color-card)]">
                    <Image
                      src={img}
                      alt=""
                      class="h-full w-full object-cover transition-transform duration-500 group-hover:scale-105"
                      loading="lazy"
                      width={600}
                      height={400}
                      format="webp"
                      quality={80}
                    />
                  </div>
                ))}
              </div>
            </div>
          )
        }
      </div>

      <!-- ПРАВАЯ КОЛОНКА (SIDEBAR) -->
      <aside class="space-y-6">
        <div class="glass-card sticky top-24 rounded-2xl border border-[var(--color-border)] p-6">
          <h4
            class="mb-6 border-b border-[var(--color-border)] pb-4 text-sm font-bold tracking-wider text-[var(--color-muted-foreground)] uppercase"
          >
            <span class="lang-ru">Техническое досье</span>
            <span class="lang-en">Technical Brief</span>
          </h4>

          <div class="space-y-6">
            <div>
              <div class="mb-1 text-xs text-[var(--color-muted-foreground)]">
                <span class="lang-ru">Категория</span><span class="lang-en">Category</span>
              </div>
              <div
                class="flex items-center gap-2 font-semibold text-[var(--color-foreground)] capitalize"
              >
                {data.type}
              </div>
            </div>

            <div>
              <div class="mb-2 text-xs text-[var(--color-muted-foreground)]">
                <span class="lang-ru">Стек технологий</span><span class="lang-en">Tech Stack</span>
              </div>
              <div class="flex flex-wrap gap-2">
                {
                  data.tags.map((tag: string) => (
                    <span class="cursor-default rounded-md border border-[var(--color-border)] bg-[var(--color-foreground)]/5 px-2.5 py-1 text-xs font-medium text-[var(--color-muted-foreground)] transition-colors hover:border-[var(--color-primary)] hover:text-[var(--color-primary)]">
                      {tag}
                    </span>
                  ))
                }
              </div>
            </div>

            <div class="h-px bg-[var(--color-border)]"></div>

            <div class="grid grid-cols-1 gap-3">
              {
                !data.demoUrl && !data.repoUrl && (
                  <div class="rounded-lg border border-[var(--color-border)] bg-[var(--color-background)]/50 p-3 text-center text-sm text-[var(--color-muted-foreground)]">
                    <span class="lang-ru">Проект под NDA (Приватный репозиторий)</span>
                    <span class="lang-en">NDA Protected (Private Repository)</span>
                  </div>
                )
              }
            </div>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <!-- CTA SECTION (No changes needed) -->
  <section class="container mx-auto max-w-4xl px-4 py-16 md:py-24">
    <!-- ...existing code... -->
    <div
      class="glass-card relative overflow-hidden rounded-3xl border border-[var(--color-primary)]/30 p-8 text-center md:p-12"
    >
      <div class="relative z-10 flex flex-col items-center">
        <h2 class="font-cinzel text-glow mb-4 text-3xl font-bold md:text-5xl">
          <span class="lang-ru">Нужен подобный проект?</span>
          <span class="lang-en">Need something like this?</span>
        </h2>
        <a
          href="https://t.me/jerseyfc"
          target="_blank"
          rel="noopener noreferrer"
          class="btn-primary group mt-8 flex items-center gap-3 px-8 py-4 text-lg"
        >
          <TelegramIcon class="h-6 w-6" />
          <span class="lang-ru">Написать в Telegram</span>
          <span class="lang-en">Contact via Telegram</span>
        </a>
      </div>
    </div>
  </section>

  <Footer />

  <!-- Image Modal Script (No changes needed) -->
  <div id="image-modal" class="image-modal hidden" aria-hidden="true" role="dialog">
    <div id="modal-backdrop" class="image-modal-backdrop"></div>
    <button id="modal-close" class="image-modal-close">×</button>
    <img id="modal-img" class="image-modal-img" alt="" />
  </div>

  <script>
    // ...existing script...
    function initImageModal() {
      // ...existing code...
    }
    document.addEventListener('astro:page-load', initImageModal);
  </script>
</Layout>

<style is:global>
  /* Markdown Styles (оставляем без изменений) */
  .markdown-container ul {
    list-style-type: disc;
    padding-left: 1.5em;
    margin-bottom: 1em;
  }
  .markdown-container ol {
    list-style-type: decimal;
    padding-left: 1.5em;
    margin-bottom: 1em;
  }
  .markdown-container strong {
    color: var(--color-foreground);
    font-weight: 700;
  }
  .markdown-container p {
    margin-bottom: 1em;
  }
  .markdown-container *:last-child {
    margin-bottom: 0;
  }

  /* Modal Styles (No changes) */
  .image-modal {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    padding: 2rem;
    backdrop-filter: blur(6px);
  }
  .image-modal.hidden {
    display: none;
  }
  .image-modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
  }
  .image-modal-img {
    max-width: 92%;
    max-height: 92%;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
    transition: transform 200ms ease;
  }
  .image-modal-open .image-modal-img {
    transform: scale(1);
  }
  .image-modal-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    z-index: 2010;
    background: none;
    border: none;
    color: #fff;
    font-size: 2rem;
    line-height: 1;
    cursor: pointer;
  }
</style>

<script>
  // ...existing script for back link...
  function initBackLink() {
    const link = document.getElementById('back-link');
    if (!link) return;
    link.addEventListener('click', (e) => {
      if (window.history.length > 1) {
        e.preventDefault();
        window.history.back();
      }
    });
  }
  document.addEventListener('astro:page-load', initBackLink);
</script>
